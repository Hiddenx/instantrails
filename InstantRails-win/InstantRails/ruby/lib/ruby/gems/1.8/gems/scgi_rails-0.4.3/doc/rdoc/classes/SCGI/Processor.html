<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: SCGI::Processor</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">SCGI::Processor</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/scgi_rb.html">
                lib/scgi.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Monitor
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
This is the complete guts of the <a href="../SCGI.html">SCGI</a> system. It
is designed so that people can take it and implement it for their own
systems, not just Ruby on Rails. This implementation is not complete since
you must create your own that implements the <a
href="Processor.html#M000013">process_request</a> method.
</p>
<p>
The <a href="Processor.html">SCGI::Processor</a> is designed to be as fast
as possible under Ruby 1.8.2 without sacrificing simplicity. This one class
is actually the entire <a href="../SCGI.html">SCGI</a> core and is the
result of careful analysis and performance tuning. Be very concious of how
you change things before you do it, and do a performance test before and
AFTER you make change to confirm that it actually runs faster.
</p>
<p>
The <a href="../SCGI.html">SCGI</a> protocol only works with TCP/IP sockets
and not domain sockets. It might be useful for shared hosting people to
have domain sockets, but they aren&#8217;t supported in Apache, and in
lighttpd they&#8217;re unreliable. Also, domain sockets don&#8217;t work so
well on Windows.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000010">collect_thread</a>&nbsp;&nbsp;
      <a href="#M000008">configure</a>&nbsp;&nbsp;
      <a href="#M000011">handle_client</a>&nbsp;&nbsp;
      <a href="#M000009">listen</a>&nbsp;&nbsp;
      <a href="#M000007">new</a>&nbsp;&nbsp;
      <a href="#M000013">process_request</a>&nbsp;&nbsp;
      <a href="#M000012">read_header</a>&nbsp;&nbsp;
      <a href="#M000015">shutdown</a>&nbsp;&nbsp;
      <a href="#M000014">status</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">settings</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000007" class="method-detail">
        <a name="M000007"></a>

        <div class="method-heading">
          <a href="Processor.src/M000007.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000007.html');return false;">
          <span class="method-name">new</span><span class="method-args">(settings = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The settings come from a YAML file which is usually created by the <a
href="Configuration.html">SCGI::Configuration</a> class. Not all
configuration settings are used by <a
href="Processor.html">SCGI::Processor</a>. The ones used are are: :logfile,
:maxconns, :host, :port, :throttle.
</p>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="Processor.src/M000010.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000010.html');return false;">
          <span class="method-name">collect_thread</span><span class="method-args">(thread)</span>
          </a>
        </div>
      
        <div class="method-description">
        </div>
      </div>

      <div id="method-M000008" class="method-detail">
        <a name="M000008"></a>

        <div class="method-heading">
          <a href="Processor.src/M000008.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000008.html');return false;">
          <span class="method-name">configure</span><span class="method-args">(settings)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Used internally during initialize, and also called by <a
href="Controller.html">SCGI::Controller</a> to force the <a
href="Processor.html">SCGI::Processor</a> to reload it&#8217;s
configuration. This reconfigure will only reload the :maxconns and
:throttle settings since those are the only ones that can be soft loaded.
Other configurations require a restart.
</p>
        </div>
      </div>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="Processor.src/M000011.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000011.html');return false;">
          <span class="method-name">handle_client</span><span class="method-args">(socket)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Internal function that handles a new client connection. It spawns a thread
to handle the client and registers it in the @threads queue. A collector
thread is responsible for joining these and clearing them out. This design
is needed because Ruby&#8217;s GC doesn&#8217;t seem to deal with threads
as well as others believe.
</p>
<p>
Depending on how your system works, you may need to synchronize inside your
<a href="Processor.html#M000013">process_request</a> implementation. The
scgi_service script for Ruby on Rails does this so that Rails will run as
if it were single threaded.
</p>
<p>
It also handles calculating the current and total connections, and deals
with the graceful shutdown. The important part of graceful shutdown is that
new requests get redirected to the /busy.html file.
</p>
        </div>
      </div>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="Processor.src/M000009.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000009.html');return false;">
          <span class="method-name">listen</span><span class="method-args">(socket = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Starts the <a href="Processor.html">SCGI::Processor</a> having it listen on
either the given socket or listening to a new socket on the @host/@port
configured. The option to give listen a socket is there so that others can
create one socket, and then fork several processors to listen to it. This
forked listening does work, but there were reports that it wasn&#8217;t
reliable so I&#8217;ve removed it from the <a href="../SCGI.html">SCGI</a>
Rails Runner project.
</p>
<p>
This function does not return until a shutdown.
</p>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="Processor.src/M000013.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000013.html');return false;">
          <span class="method-name">process_request</span><span class="method-args">(request, body, socket)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
You must implement this yourself. The request is a Hash of the CGI
parameters from the webserver. The body is the raw CGI body. The socket is
where you write your results (properly HTTP formatted) back to the
webserver.
</p>
        </div>
      </div>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="Processor.src/M000012.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000012.html');return false;">
          <span class="method-name">read_header</span><span class="method-args">(socket, payload)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Does three jobs: reads and parses the <a href="../SCGI.html">SCGI</a>
netstring header, reads any content off the socket, and then either calls
<a href="Processor.html#M000013">process_request</a> or immediately returns
a redirect to /busy.html for some connections.
</p>
<p>
The browser/connection that will be redirected to /busy.html if either <a
href="Processor.html">SCGI::Processor</a> is in the middle of a shutdown,
or if the number of connections is over the @maxconns. This redirect is
immediate and doesn&#8217;t run your system, so it will happen with much
less processing and help keep your system responsive.
</p>
        </div>
      </div>

      <div id="method-M000015" class="method-detail">
        <a name="M000015"></a>

        <div class="method-heading">
          <a href="Processor.src/M000015.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000015.html');return false;">
          <span class="method-name">shutdown</span><span class="method-args">(force = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
When called it will set the @shutdown flag indicating to the <a
href="Processor.html#M000009">SCGI::Processor.listen</a> function that all
new connections should be set to /busy.html, and all current connections
should be &quot;valved&quot; off. Once all the current connections are gone
the <a href="Processor.html#M000009">SCGI::Processor.listen</a> function
will exit.
</p>
<p>
Use the force=true parameter to force an immediate shutdown. This is done
by closing the listening socket, so it&#8217;s rather violent.
</p>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="Processor.src/M000014.html" target="Code" class="method-signature"
            onclick="popupCode('Processor.src/M000014.html');return false;">
          <span class="method-name">status</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns a Hash with status information. This is used by the <a
href="Controller.html">SCGI::Controller</a> to give status.
</p>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>