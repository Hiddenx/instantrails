<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: ActiveRecord::Associations::ClassMethods</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">ActiveRecord::Associations::ClassMethods</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/active_record/associations_rb.html">
                lib/active_record/associations.rb
                </a>
        <br />
                <a href="../../../files/lib/active_record/deprecated_associations_rb.html">
                lib/active_record/deprecated_associations.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Associations are a set of macro-like class methods for tying objects
together through foreign keys. They express relationships like
&quot;Project has one Project Manager&quot; or &quot;Project belongs to a
Portfolio&quot;. Each macro adds a number of methods to the class which are
specialized according to the collection or association symbol and the
options hash. It works much the same way as Ruby&#8217;s own attr* methods.
Example:
</p>
<pre>
  class Project &lt; ActiveRecord::Base
    belongs_to              :portfolio
    has_one                 :project_manager
    has_many                :milestones
    has_and_belongs_to_many :categories
  end
</pre>
<p>
The project class now has the following methods (and more) to ease the
traversal and manipulation of its relationships:
</p>
<ul>
<li><tt>Project#portfolio, Project#portfolio=(portfolio),
Project#portfolio.nil?</tt>

</li>
<li><tt>Project#project_manager, Project#project_manager=(project_manager),
Project#project_manager.nil?,</tt>

</li>
<li><tt>Project#milestones.empty?, Project#milestones.size, Project#milestones,
Project#milestones&lt;&lt;(milestone),</tt>
<tt>Project#milestones.delete(milestone),
Project#milestones.find(milestone_id),
Project#milestones.find_all(conditions),</tt> <tt>Project#milestones.build,
Project#milestones.create</tt>

</li>
<li><tt>Project#categories.empty?, Project#categories.size, Project#categories,
Project#categories&lt;&lt;(category1),</tt>
<tt>Project#categories.delete(category1)</tt>

</li>
</ul>
<h2>Example</h2>
<p>
<img src="../../../files/examples/associations.png">
</p>
<h2>Is it <a href="ClassMethods.html#M000258">belongs_to</a> or has_one?</h2>
<p>
Both express a 1-1 relationship, the difference is mostly where to place
the foreign key, which goes on the table for the class saying <a
href="ClassMethods.html#M000258">belongs_to</a>. Example:
</p>
<pre>
  class Post &lt; ActiveRecord::Base
    has_one :author
  end

  class Author &lt; ActiveRecord::Base
    belongs_to :post
  end
</pre>
<p>
The tables for these classes could look something like:
</p>
<pre>
  CREATE TABLE posts (
    id int(11) NOT NULL auto_increment,
    title varchar default NULL,
    PRIMARY KEY  (id)
  )

  CREATE TABLE authors (
    id int(11) NOT NULL auto_increment,
    post_id int(11) default NULL,
    name varchar default NULL,
    PRIMARY KEY  (id)
  )
</pre>
<h2>Unsaved objects and associations</h2>
<p>
You can manipulate objects and associations before they are saved to the
database, but there is some special behaviour you should be aware of,
mostly involving the saving of associated objects.
</p>
<h3>One-to-one associations</h3>
<ul>
<li>Assigning an object to a <a href="ClassMethods.html#M000257">has_one</a>
association automatically saves that object and the object being replaced
(if there is one), in order to update their primary keys - except if the
parent object is unsaved (new_record? == true).

</li>
<li>If either of these saves fail (due to one of the objects being invalid) the
assignment statement returns false and the assignment is cancelled.

</li>
<li>If you wish to assign an object to a <a
href="ClassMethods.html#M000257">has_one</a> association without saving it,
use the association.build method (documented below).

</li>
<li>Assigning an object to a <a href="ClassMethods.html#M000258">belongs_to</a>
association does not save the object, since the foreign key field belongs
on the parent. It does not save the parent either.

</li>
</ul>
<h3>Collections</h3>
<ul>
<li>Adding an object to a collection (<a
href="ClassMethods.html#M000256">has_many</a> or <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a>) automatically
saves that object, except if the parent object (the owner of the
collection) is not yet stored in the database.

</li>
<li>If saving any of the objects being added to a collection (via push or
similar) fails, then push returns false.

</li>
<li>You can add an object to a collection without automatically saving it by
using the collection.build method (documented below).

</li>
<li>All unsaved (new_record? == true) members of the collection are
automatically saved when the parent is saved.

</li>
</ul>
<h3>Association callbacks</h3>
<p>
Similiar to the normal callbacks that hook into the lifecycle of an Active
Record object, you can also define callbacks that get trigged when you add
an object to or removing an object from a association collection. Example:
</p>
<pre>
  class Project
    has_and_belongs_to_many :developers, :after_add =&gt; :evaluate_velocity

    def evaluate_velocity(developer)
      ...
    end
  end
</pre>
<p>
It&#8217;s possible to stack callbacks by passing them as an array.
Example:
</p>
<pre>
  class Project
    has_and_belongs_to_many :developers, :after_add =&gt; [:evaluate_velocity, Proc.new { |p, d| p.shipping_date = Time.now}]
  end
</pre>
<p>
Possible callbacks are: before_add, after_add, before_remove and
after_remove.
</p>
<p>
Should any of the before_add callbacks throw an exception, the object does
not get added to the collection. Same with the before_remove callbacks, if
an exception is thrown the object doesn&#8217;t get removed.
</p>
<h3>Association extensions</h3>
<p>
The proxy objects that controls the access to associations can be extended
through anonymous modules. This is especially beneficial for adding new
finders, creators, and other factory-type methods that are only used as
part of this associatio. Example:
</p>
<pre>
  class Account &lt; ActiveRecord::Base
    has_many :people do
      def find_or_create_by_name(name)
        first_name, *last_name = name.split
        last_name = last_name.join &quot; &quot;

        find_or_create_by_first_name_and_last_name(first_name, last_name)
      end
    end
  end

  person = Account.find(:first).people.find_or_create_by_name(&quot;David Heinemeier Hansson&quot;)
  person.first_name # =&gt; &quot;David&quot;
  person.last_name  # =&gt; &quot;Heinemeier Hansson&quot;
</pre>
<p>
If you need to share the same extensions between many associations, you can
use a named extension module. Example:
</p>
<pre>
  module FindOrCreateByNameExtension
    def find_or_create_by_name(name)
      first_name, *last_name = name.split
      last_name = last_name.join &quot; &quot;

      find_or_create_by_first_name_and_last_name(first_name, last_name)
    end
  end

  class Account &lt; ActiveRecord::Base
    has_many :people, :extend =&gt; FindOrCreateByNameExtension
  end

  class Company &lt; ActiveRecord::Base
    has_many :people, :extend =&gt; FindOrCreateByNameExtension
  end
</pre>
<h2>Caching</h2>
<p>
All of the methods are built on a simple caching principle that will keep
the result of the last query around unless specifically instructed not to.
The cache is even shared across methods to make it even cheaper to use the
macro-added methods without worrying too much about performance at the
first go. Example:
</p>
<pre>
  project.milestones             # fetches milestones from the database
  project.milestones.size        # uses the milestone cache
  project.milestones.empty?      # uses the milestone cache
  project.milestones(true).size  # fetches milestones from the database
  project.milestones             # uses the milestone cache
</pre>
<h2>Eager loading of associations</h2>
<p>
Eager loading is a way to find objects of a certain class and a number of
named associations along with it in a single SQL call. This is one of the
easiest ways of to prevent the dreaded 1+N problem in which fetching 100
posts that each needs to display their author triggers 101 database
queries. Through the use of eager loading, the 101 queries can be reduced
to 1. Example:
</p>
<pre>
  class Post &lt; ActiveRecord::Base
    belongs_to :author
    has_many   :comments
  end
</pre>
<p>
Consider the following loop using the class above:
</p>
<pre>
  for post in Post.find(:all)
    puts &quot;Post:            &quot; + post.title
    puts &quot;Written by:      &quot; + post.author.name
    puts &quot;Last comment on: &quot; + post.comments.first.created_on
  end
</pre>
<p>
To iterate over these one hundred posts, we&#8217;ll generate 201 database
queries. Let&#8217;s first just optimize it for retrieving the author:
</p>
<pre>
  for post in Post.find(:all, :include =&gt; :author)
</pre>
<p>
This references the name of the <a
href="ClassMethods.html#M000258">belongs_to</a> association that also used
the :author symbol, so the find will now weave in a join something like
this: LEFT OUTER JOIN authors ON authors.id = posts.author_id. Doing so
will cut down the number of queries from 201 to 101.
</p>
<p>
We can improve upon the situation further by referencing both associations
in the finder with:
</p>
<pre>
  for post in Post.find(:all, :include =&gt; [ :author, :comments ])
</pre>
<p>
That&#8216;ll add another join along the lines of: LEFT OUTER JOIN comments
ON comments.post_id = posts.id. And we&#8217;ll be down to 1 query. But
that shouldn&#8217;t fool you to think that you can pull out huge amounts
of data with no performance penalty just because you&#8217;ve reduced the
number of queries. The database still needs to send all the data to Active
Record and it still needs to be processed. So it&#8217;s no catch-all for
performance problems, but it&#8217;s a great way to cut down on the number
of queries in a situation as the one described above.
</p>
<p>
Please note that limited eager loading with <a
href="ClassMethods.html#M000256">has_many</a> and <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a> associations
is not compatible with describing conditions on these eager tables. This
will work:
</p>
<pre>
  Post.find(:all, :include =&gt; :comments, :conditions =&gt; &quot;posts.title = 'magic forest'&quot;, :limit =&gt; 2)
</pre>
<p>
&#8230;but this will not (and an ArgumentError will be raised):
</p>
<pre>
  Post.find(:all, :include =&gt; :comments, :conditions =&gt; &quot;comments.body like 'Normal%'&quot;, :limit =&gt; 2)
</pre>
<p>
Also have in mind that since the eager loading is pulling from multiple
tables, you&#8217;ll have to disambiguate any column references in both
conditions and orders. So :order =&gt; &quot;posts.id DESC&quot; will work
while :order =&gt; &quot;id DESC&quot; will not. This may require that you
alter the :order and :conditions on the association definitions themselves.
</p>
<p>
It&#8217;s currently not possible to use eager loading on multiple
associations from the same table. Eager loading will also not pull
additional attributes on join tables, so &quot;rich associations&quot; with
<a href="ClassMethods.html#M000259">has_and_belongs_to_many</a> is not a
good fit for eager loading.
</p>
<h2>Modules</h2>
<p>
By default, associations will look for objects within the current module
scope. Consider:
</p>
<pre>
  module MyApplication
    module Business
      class Firm &lt; ActiveRecord::Base
         has_many :clients
       end

      class Company &lt; ActiveRecord::Base; end
    end
  end
</pre>
<p>
When Firm#clients is called, it&#8217;ll in turn call
<tt>MyApplication::Business::Company.find(firm.id)</tt>. If you want to
associate with a class in another module scope this can be done by
specifying the complete class name, such as:
</p>
<pre>
  module MyApplication
    module Business
      class Firm &lt; ActiveRecord::Base; end
    end

    module Billing
      class Account &lt; ActiveRecord::Base
        belongs_to :firm, :class_name =&gt; &quot;MyApplication::Business::Firm&quot;
      end
    end
  end
</pre>
<h2>Type safety with ActiveRecord::AssociationTypeMismatch</h2>
<p>
If you attempt to assign an object to an association that doesn&#8217;t
match the inferred or specified <tt>:class_name</tt>, you&#8217;ll get a
ActiveRecord::AssociationTypeMismatch.
</p>
<h2>Options</h2>
<p>
All of the association macros can be specialized through options which
makes more complex cases than the simple and guessable ones possible.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000258">belongs_to</a>&nbsp;&nbsp;
      <a href="#M000259">has_and_belongs_to_many</a>&nbsp;&nbsp;
      <a href="#M000256">has_many</a>&nbsp;&nbsp;
      <a href="#M000257">has_one</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000258" class="method-detail">
        <a name="M000258"></a>

        <div class="method-heading">
          <a href="ClassMethods.src/M000258.html" target="Code" class="method-signature"
            onclick="popupCode('ClassMethods.src/M000258.html');return false;">
          <span class="method-name">belongs_to</span><span class="method-args">(association_id, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the following methods for retrieval and query for a single associated
object that this object holds an id to. <tt>association</tt> is replaced
with the symbol passed as the first argument, so <tt><a
href="ClassMethods.html#M000258">belongs_to</a> :author</tt> would add
among others <tt>author.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - returns the associated object.
Nil is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - assigns the associate object, extracts
the primary key, and sets it as the foreign key.

</li>
<li><tt>association.nil?</tt> - returns true if there is no associated object.

</li>
<li><tt>build_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.

</li>
<li><tt>create_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation).

</li>
</ul>
<p>
Example: A Post class declares <tt><a
href="ClassMethods.html#M000258">belongs_to</a> :author</tt>, which will
add:
</p>
<ul>
<li><tt>Post#author</tt> (similar to <tt>Author.find(author_id)</tt>)

</li>
<li><tt>Post#author=(author)</tt> (similar to <tt>post.author_id =
author.id</tt>)

</li>
<li><tt>Post#author?</tt> (similar to <tt>post.author == some_author</tt>)

</li>
<li><tt>Post#author.nil?</tt>

</li>
<li><tt>Post#build_author</tt> (similar to <tt>post.author = Author.new</tt>)

</li>
<li><tt>Post#create_author</tt> (similar to <tt>post.author = Author.new;
post.author.save; post.author</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000257">has_one</a> :author</tt> will by
default be linked to the <tt>Author</tt> class, but if the real class name
is <tt>Person</tt>, you&#8217;ll have to specify it with this option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;authorized = 1&quot;.

</li>
<li><tt>:order</tt> - specify the order from which the associated object will
be picked at the top. Specified as an &quot;ORDER BY&quot; sql fragment,
such as &quot;last_name, first_name DESC&quot;

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of the associated class in
lower-case and &quot;_id&quot; suffixed. So a <tt>Person</tt> class that
makes a <a href="ClassMethods.html#M000258">belongs_to</a> association to a
<tt>Boss</tt> class will use &quot;boss_id&quot; as the default
foreign_key.

</li>
<li><tt>:counter_cache</tt> - caches the number of belonging objects on the
associate class through use of increment_counter and decrement_counter. The
counter cache is incremented when an object of this class is created and
decremented when it&#8217;s destroyed. This requires that a column named
&quot;#{table_name}_count&quot; (such as comments_count for a belonging
Comment class) is used on the associate class (such as a Post class).

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when this object is loaded.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  belongs_to :firm, :foreign_key =&gt; &quot;client_of&quot;
  belongs_to :author, :class_name =&gt; &quot;Person&quot;, :foreign_key =&gt; &quot;author_id&quot;
  belongs_to :valid_coupon, :class_name =&gt; &quot;Coupon&quot;, :foreign_key =&gt; &quot;coupon_id&quot;,
             :conditions =&gt; 'discounts &gt; #{payments_count}'
</pre>
        </div>
      </div>

      <div id="method-M000259" class="method-detail">
        <a name="M000259"></a>

        <div class="method-heading">
          <a href="ClassMethods.src/M000259.html" target="Code" class="method-signature"
            onclick="popupCode('ClassMethods.src/M000259.html');return false;">
          <span class="method-name">has_and_belongs_to_many</span><span class="method-args">(association_id, options = {}, &amp;extension)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Associates two classes via an intermediate join table. Unless the join
table is explicitly specified as an option, it is guessed using the lexical
order of the class names. So a join between Developer and Project will give
the default join table name of &quot;developers_projects&quot; because
&quot;D&quot; outranks &quot;P&quot;.
</p>
<p>
Any additional fields added to the join table will be placed as attributes
when pulling records out through <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a> associations.
This is helpful when have information about the association itself that you
want available on retrieval. Note that any fields in the join table will
override matching field names in the two joined tables. As a consequence,
having an &quot;id&quot; field in the join table usually has the
undesirable result of clobbering the &quot;id&quot; fields in either of the
other two tables.
</p>
<p>
Adds the following methods for retrieval and query. <tt>collection</tt> is
replaced with the symbol passed as the first argument, so <tt><a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a>
:categories</tt> would add among others <tt>categories.empty?</tt>.
</p>
<ul>
<li><tt>collection(force_reload = false)</tt> - returns an array of all the
associated objects. An empty array is returned if none is found.

</li>
<li><tt>collection&lt;&lt;(object, &#8230;)</tt> - adds one or more objects to
the collection by creating associations in the join table (collection.push
and collection.concat are aliases to this method).

</li>
<li><tt>collection.push_with_attributes(object, join_attributes)</tt> - adds
one to the collection by creating an association in the join table that
also holds the attributes from <tt>join_attributes</tt> (should be a hash
with the column names as keys). This can be used to have additional
attributes on the join, which will be injected into the associated objects
when they are retrieved through the collection.
(collection.concat_with_attributes is an alias to this method).

</li>
<li><tt>collection.delete(object, &#8230;)</tt> - removes one or more objects
from the collection by removing their associations from the join table.
This does not destroy the objects.

</li>
<li><tt>collection=objects</tt> - replaces the collections content by deleting
and adding objects as appropriate.

</li>
<li><tt>collection_singular_ids=ids</tt> - replace the collection by the
objects identified by the primary keys in <tt>ids</tt>

</li>
<li><tt>collection.clear</tt> - removes every object from the collection. This
does not destroy the objects.

</li>
<li><tt>collection.empty?</tt> - returns true if there are no associated
objects.

</li>
<li><tt>collection.size</tt> - returns the number of associated objects.

</li>
<li><tt>collection.find(id)</tt> - finds an associated object responding to the
<tt>id</tt> and that meets the condition that it has to be associated with
this object.

</li>
</ul>
<p>
Example: An Developer class declares <tt><a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a>
:projects</tt>, which will add:
</p>
<ul>
<li><tt>Developer#projects</tt>

</li>
<li><tt>Developer#projects&lt;&lt;</tt>

</li>
<li><tt>Developer#projects.push_with_attributes</tt>

</li>
<li><tt>Developer#projects.delete</tt>

</li>
<li><tt>Developer#projects=</tt>

</li>
<li><tt>Developer#project_ids=</tt>

</li>
<li><tt>Developer#projects.clear</tt>

</li>
<li><tt>Developer#projects.empty?</tt>

</li>
<li><tt>Developer#projects.size</tt>

</li>
<li><tt>Developer#projects.find(id)</tt>

</li>
</ul>
<p>
The declaration may include an options hash to specialize the behavior of
the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000259">has_and_belongs_to_many</a>
:projects</tt> will by default be linked to the <tt>Project</tt> class, but
if the real class name is <tt>SuperProject</tt>, you&#8217;ll have to
specify it with this option.

</li>
<li><tt>:join_table</tt> - specify the name of the join table if the default
based on lexical order isn&#8217;t what you want. WARNING: If you&#8217;re
overwriting the table name of either class, the table_name method MUST be
declared underneath any <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a> declaration in
order to work.

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a> association
will use &quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:association_foreign_key</tt> - specify the association foreign key
used for the association. By default this is guessed to be the name of the
associated class in lower-case and &quot;_id&quot; suffixed. So if the
associated class is <tt>Project</tt>, the <a
href="ClassMethods.html#M000259">has_and_belongs_to_many</a> association
will use &quot;project_id&quot; as the default association foreign_key.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;authorized = 1&quot;.

</li>
<li><tt>:order</tt> - specify the order in which the associated objects are
returned as a &quot;ORDER BY&quot; sql fragment, such as &quot;last_name,
first_name DESC&quot;

</li>
<li><tt>:uniq</tt> - if set to true, duplicate associated objects will be
ignored by accessors and query methods

</li>
<li><tt>:finder_sql</tt> - overwrite the default generated SQL used to fetch
the association with a manual one

</li>
<li><tt>:delete_sql</tt> - overwrite the default generated SQL used to remove
links between the associated classes with a manual one

</li>
<li><tt>:insert_sql</tt> - overwrite the default generated SQL used to add
links between the associated classes with a manual one

</li>
<li><tt>:extend</tt> - anonymous module for extending the proxy, see
&quot;Association extensions&quot;.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when the collection is loaded.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_and_belongs_to_many :projects
  has_and_belongs_to_many :projects, :include =&gt; [ :milestones, :manager ]
  has_and_belongs_to_many :nations, :class_name =&gt; &quot;Country&quot;
  has_and_belongs_to_many :categories, :join_table =&gt; &quot;prods_cats&quot;
  has_and_belongs_to_many :active_projects, :join_table =&gt; 'developers_projects', :delete_sql =&gt;
  'DELETE FROM developers_projects WHERE active=1 AND developer_id = #{id} AND project_id = #{record.id}'
</pre>
        </div>
      </div>

      <div id="method-M000256" class="method-detail">
        <a name="M000256"></a>

        <div class="method-heading">
          <a href="ClassMethods.src/M000256.html" target="Code" class="method-signature"
            onclick="popupCode('ClassMethods.src/M000256.html');return false;">
          <span class="method-name">has_many</span><span class="method-args">(association_id, options = {}, &amp;extension)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the following methods for retrieval and query of collections of
associated objects. <tt>collection</tt> is replaced with the symbol passed
as the first argument, so <tt><a
href="ClassMethods.html#M000256">has_many</a> :clients</tt> would add among
others <tt>clients.empty?</tt>.
</p>
<ul>
<li><tt>collection(force_reload = false)</tt> - returns an array of all the
associated objects. An empty array is returned if none are found.

</li>
<li><tt>collection&lt;&lt;(object, &#8230;)</tt> - adds one or more objects to
the collection by setting their foreign keys to the collection&#8217;s
primary key.

</li>
<li><tt>collection.delete(object, &#8230;)</tt> - removes one or more objects
from the collection by setting their foreign keys to NULL. This will also
destroy the objects if they&#8217;re declared as <a
href="ClassMethods.html#M000258">belongs_to</a> and dependent on this
model.

</li>
<li><tt>collection=objects</tt> - replaces the collections content by deleting
and adding objects as appropriate.

</li>
<li><tt>collection_singular_ids=ids</tt> - replace the collection by the
objects identified by the primary keys in <tt>ids</tt>

</li>
<li><tt>collection.clear</tt> - removes every object from the collection. This
destroys the associated objects if they are <tt>:dependent</tt>, deletes
them directly from the database if they are
<tt>:exclusively_dependent</tt>, and sets their foreign keys to NULL
otherwise.

</li>
<li><tt>collection.empty?</tt> - returns true if there are no associated
objects.

</li>
<li><tt>collection.size</tt> - returns the number of associated objects.

</li>
<li><tt>collection.find</tt> - finds an associated object according to the same
rules as <a href="../Base.html#M000500">Base.find</a>.

</li>
<li><tt>collection.build(attributes = {})</tt> - returns a new object of the
collection type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.
*Note:* This only works if an associated object already exists, not if
it&#8217;s nil!

</li>
<li><tt>collection.create(attributes = {})</tt> - returns a new object of the
collection type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation). *Note:* This only works if an associated
object already exists, not if it&#8217;s nil!

</li>
</ul>
<p>
Example: A Firm class declares <tt><a
href="ClassMethods.html#M000256">has_many</a> :clients</tt>, which will
add:
</p>
<ul>
<li><tt>Firm#clients</tt> (similar to <tt>Clients.find :all, :conditions =&gt;
&quot;firm_id = #{id}&quot;</tt>)

</li>
<li><tt>Firm#clients&lt;&lt;</tt>

</li>
<li><tt>Firm#clients.delete</tt>

</li>
<li><tt>Firm#clients=</tt>

</li>
<li><tt>Firm#client_ids=</tt>

</li>
<li><tt>Firm#clients.clear</tt>

</li>
<li><tt>Firm#clients.empty?</tt> (similar to <tt>firm.clients.size == 0</tt>)

</li>
<li><tt>Firm#clients.size</tt> (similar to <tt>Client.count &quot;firm_id =
#{id}&quot;</tt>)

</li>
<li><tt>Firm#clients.find</tt> (similar to <tt>Client.find(id, :conditions
=&gt; &quot;firm_id = #{id}&quot;)</tt>)

</li>
<li><tt>Firm#clients.build</tt> (similar to <tt>Client.new(&quot;firm_id&quot;
=&gt; id)</tt>)

</li>
<li><tt>Firm#clients.create</tt> (similar to <tt>c =
Client.new(&quot;firm_id&quot; =&gt; id); c.save; c</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000256">has_many</a> :products</tt> will by
default be linked to the <tt>Product</tt> class, but if the real class name
is <tt>SpecialProduct</tt>, you&#8217;ll have to specify it with this
option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated objects
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;price &gt; 5 AND name LIKE &#8216;B%&#8217;&quot;.

</li>
<li><tt>:order</tt> - specify the order in which the associated objects are
returned as a &quot;ORDER BY&quot; sql fragment, such as &quot;last_name,
first_name DESC&quot;

</li>
<li><tt>:group</tt> - specify the attribute by which the associated objects are
returned as a &quot;GROUP BY&quot; sql fragment, such as
&quot;category&quot;

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000256">has_many</a> association will use
&quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:dependent</tt> - if set to :destroy (or true) all the associated
objects are destroyed alongside this object by calling their destroy
method. If set to :delete_all all associated objects are deleted
<b>without</b> calling their destroy method. If set to :nullify all
associated objects&#8217; foreign keys are set to NULL <b>without</b>
calling their save callbacks. May not be set if :exclusively_dependent is
also set.

</li>
<li><tt>:exclusively_dependent</tt> - Deprecated; equivalent to :dependent
=&gt; :delete_all. If set to true all the associated object are deleted in
one SQL statement without having their before_destroy callback run. This
should only be used on associations that depend solely on this class and
don&#8217;t need to do any clean-up in before_destroy. The upside is that
it&#8217;s much faster, especially if there&#8217;s a counter_cache
involved. May not be set if :dependent is also set.

</li>
<li><tt>:finder_sql</tt> - specify a complete SQL statement to fetch the
association. This is a good way to go for complex associations that depend
on multiple tables. Note: When this option is used,
<tt>find_in_collection</tt> is <em>not</em> added.

</li>
<li><tt>:counter_sql</tt> - specify a complete SQL statement to fetch the size
of the association. If +:finder_sql+ is specified but +:counter_sql+,
+:counter_sql+ will be generated by replacing SELECT &#8230; FROM with
SELECT COUNT(*) FROM.

</li>
<li><tt>:extend</tt> - specify a named module for extending the proxy, see
&quot;Association extensions&quot;.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when the collection is loaded.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_many :comments, :order =&gt; &quot;posted_on&quot;
  has_many :comments, :include =&gt; :author
  has_many :people, :class_name =&gt; &quot;Person&quot;, :conditions =&gt; &quot;deleted = 0&quot;, :order =&gt; &quot;name&quot;
  has_many :tracks, :order =&gt; &quot;position&quot;, :dependent =&gt; true
  has_many :subscribers, :class_name =&gt; &quot;Person&quot;, :finder_sql =&gt;
      'SELECT DISTINCT people.* ' +
      'FROM people p, post_subscriptions ps ' +
      'WHERE ps.post_id = #{id} AND ps.person_id = p.id ' +
      'ORDER BY p.first_name'
</pre>
        </div>
      </div>

      <div id="method-M000257" class="method-detail">
        <a name="M000257"></a>

        <div class="method-heading">
          <a href="ClassMethods.src/M000257.html" target="Code" class="method-signature"
            onclick="popupCode('ClassMethods.src/M000257.html');return false;">
          <span class="method-name">has_one</span><span class="method-args">(association_id, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the following methods for retrieval and query of a single associated
object. <tt>association</tt> is replaced with the symbol passed as the
first argument, so <tt><a href="ClassMethods.html#M000257">has_one</a>
:manager</tt> would add among others <tt>manager.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - returns the associated object.
Nil is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - assigns the associate object, extracts
the primary key, sets it as the foreign key, and saves the associate
object.

</li>
<li><tt>association.nil?</tt> - returns true if there is no associated object.

</li>
<li><tt>build_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.
Note: This ONLY works if an association already exists. It will NOT work if
the association is nil.

</li>
<li><tt>create_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation).

</li>
</ul>
<p>
Example: An Account class declares <tt><a
href="ClassMethods.html#M000257">has_one</a> :beneficiary</tt>, which will
add:
</p>
<ul>
<li><tt>Account#beneficiary</tt> (similar to <tt>Beneficiary.find(:first,
:conditions =&gt; &quot;account_id = #{id}&quot;)</tt>)

</li>
<li><tt>Account#beneficiary=(beneficiary)</tt> (similar to
<tt>beneficiary.account_id = account.id; beneficiary.save</tt>)

</li>
<li><tt>Account#beneficiary.nil?</tt>

</li>
<li><tt>Account#build_beneficiary</tt> (similar to
<tt>Beneficiary.new(&quot;account_id&quot; =&gt; id)</tt>)

</li>
<li><tt>Account#create_beneficiary</tt> (similar to <tt>b =
Beneficiary.new(&quot;account_id&quot; =&gt; id); b.save; b</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000257">has_one</a> :manager</tt> will by
default be linked to the <tt>Manager</tt> class, but if the real class name
is <tt>Person</tt>, you&#8217;ll have to specify it with this option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;rank = 5&quot;.

</li>
<li><tt>:order</tt> - specify the order from which the associated object will
be picked at the top. Specified as

<pre>
 an &quot;ORDER BY&quot; sql fragment, such as &quot;last_name, first_name DESC&quot;
</pre>
</li>
<li><tt>:dependent</tt> - if set to :destroy (or true) all the associated
objects are destroyed when this object is. Also, association is assigned.

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000257">has_one</a> association will use
&quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when this object is loaded.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_one :credit_card, :dependent =&gt; true
  has_one :last_comment, :class_name =&gt; &quot;Comment&quot;, :order =&gt; &quot;posted_on&quot;
  has_one :project_manager, :class_name =&gt; &quot;Person&quot;, :conditions =&gt; &quot;role = 'project_manager'&quot;
</pre>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>