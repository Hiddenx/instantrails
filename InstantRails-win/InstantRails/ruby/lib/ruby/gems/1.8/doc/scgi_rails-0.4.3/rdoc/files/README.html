<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>File: README</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



  <div id="fileHeader">
    <h1>README</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>README
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Mon Jan 02 12:33:54 Central Standard Time 2006</td>
    </tr>
    </table>
  </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h1><a href="../classes/SCGI.html">SCGI</a> Rails Runner</h1>
<p>
<a href="../classes/SCGI.html">SCGI</a> Rails Runner is a complete
implementation of the *Simple CGI* protocol for Ruby on Rails as specified
by the <a
href="http://python.ca/nas/scgi/protocol.txt">python.ca/nas/scgi/protocol.txt</a>
specification. <a href="../classes/SCGI.html">SCGI</a> is similar to
FastCGI except that it is much simpler to implement and is actively
maintained by the original author. The primary advantages of <a
href="../classes/SCGI.html">SCGI</a> over the current FastCGI are:
</p>
<ul>
<li>Completely pure Ruby yet still quite fast when compared with FastCGI.

</li>
<li>The core implementation (<a
href="../classes/SCGI/Processor.html">SCGI::Processor</a>) is extensible
for other frameworks.

</li>
<li>Systems other than Rails can use the library to implement their own
versions.

</li>
<li>An extensive control mechanism to let you start, stop, restart, and reload
even remotely.

</li>
<li>Cluster management using the scgi_cluster tool.

</li>
<li>Configuration file based so you can set options and start from command line
easily.

</li>
<li>Runs on nearly everything with initial support for Windows.

</li>
<li>Restarts and stops are graceful, with redirects to a /busy.html page for
clients during the shutdown phase.

</li>
<li>You can set a throttle and max connections setting to reduce the load an
application puts on your system.

</li>
<li>Works with lighttpd, Apache 1.3.x and Apache 2.0.x or later. Precompiled
mod_scgi for Apache on Win32.

</li>
<li>The base library has NO external dependencies as far as I know.

</li>
</ul>
<p>
There&#8217;s quite a few other features, but I tried to keep the
complexity down while still meeting the reasonable requests of the users.
If there&#8217;s something more you think I should add then please contact
me at zedshaw AT zedshaw DOT com.
</p>
<h2>Comparison With FastCGI</h2>
<p>
<a href="../classes/SCGI.html">SCGI</a> and FastCGI have similar goals: To
keep Ruby running between requests and process the requests as fast as
possible. The difference is that <a href="../classes/SCGI.html">SCGI</a> is
much simpler and easier to implement so there&#8217;s less chance to get it
wrong.
</p>
<p>
Specifically, the <a href="../classes/SCGI.html">SCGI</a> Rails Runner
(SRR) is written in pure Ruby so it doesn&#8217;t leak memory, runs
everywhere, and is easy to install (no compilers needed).
</p>
<p>
One thing that <a href="../classes/SCGI.html">SCGI</a> doesn&#8217;t
support is using UNIX Domain sockets rather than TCP/IP sockets. This
isn&#8217;t really needed, but it is handy in a shared hosting situation
where you don&#8217;t want other connecting to your processes or if you
have to request open ports. Sorry, no UNIX Domain sockets in <a
href="../classes/SCGI.html">SCGI</a>.
</p>
<h2>Comparison With WEBrick</h2>
<p>
In theory WEBrick should be able to run just as fast as SRR. They are both
written in pure Ruby. They both do similar processing (although
WEBrick&#8217;s are a little more complicated). They both return about the
same amount of data.
</p>
<p>
In practice WEBrick in production mode runs much slower than SRR in
production mode.
</p>
<p>
If you&#8217;re doing development, I recommend using WEBrick for two
reasons. First, WEBrick is easier to start and stop since you just use
script/server. Second, on Mac OSX several people have said that SRR cannot
run in development mode. Note this is probably <b>only</b> Mac OSX. SRR
runs just fine in development mode on Linux.
</p>
<h2>Comparison With CGI</h2>
<p>
CGI is where every time a request comes in for rails the whole Ruby on
Rails framework is loaded. This is very slow, but it&#8217;s easy to
install.
</p>
<p>
An alternative is to use the cgi2scgi program distributed with the <a
href="../classes/SCGI.html">SCGI</a> source available from <a
href="http://www.mems-exchange.org/software/scgi">www.mems-exchange.org/software/scgi</a>/
along with the Apache modules. This program basically is a small little C
program that runs quickly as a CGI, but passes it&#8217;s requests to your
SRR backend. It&#8217;s not all that fast, but if you&#8217;re stuck with
cgi-bin only access then this might be just the way to go. Since <a
href="../classes/SCGI.html">SCGI</a> runs over TCP/IP you can even host
your SRR on a totally different machine with this.
</p>
<h1>Install</h1>
<p>
Installing SRR is pretty easy. There&#8217;s two main ways you can do it:
via gems or with a ruby setup script.
</p>
<h2>Requirements</h2>
<p>
To use the SRR files you&#8217;ll need a few other packages which you can
easily install via RubyGems:
</p>
<ul>
<li>cmdparse &#8212; The version used is 2.0.0

</li>
<li>highline &#8212; This is used for prompts and colors and general text UI.

</li>
<li>rails &#8212; Yeah, if I need to tell you this then you are seriously
hosed.

</li>
</ul>
<p>
NOTE: These requirements are really only for the included commands. The
actual <a href="../classes/SCGI.html">SCGI</a> implementation in scgi.rb
doesn&#8217;t have any external dependencies.
</p>
<h2>RubyGems</h2>
<p>
Simply run:
</p>
<pre>
  &gt; wget http://www.zedshaw.com/downloads/scgi_rails/scgi_rails-VERSION.gem
  &gt; gem install scgi_rails-VERSION.gem
</pre>
<p>
Replacing VERSION with the one you want. Eventually I&#8217;ll stop being
lazy and figure out how to get the gem into the official source.
</p>
<h2>Ruby Setup Script</h2>
<p>
Another way to do it is to download the source and install directly.
</p>
<pre>
  &gt; wget http://www.zedshaw.com/downloads/scgi_rails/scgi_rails-VERSION.tar.bz2
  &gt; tar -xjf scgi_rails-VERSION.tar.bz2
  &gt; cd scgi_rails-VERSION
  &gt; sudo ruby setup.rb
</pre>
<p>
These instructions are for POSIX systems like Linux or BSD of course. If
you&#8217;re on windows then you&#8217;ll be better off using the RubyGem
install method (please correct me if I&#8217;m wrong on this).
</p>
<h1>Configuring</h1>
<p>
Once you&#8217;ve installed SRR and&#8212;all the dependencies&#8212;you
can get started setting it up. The big difference between FastCGI, previous
versions of SRR, and the new version of SRR is that you first configure
your setup. After you configure your setup you can simply start/stop it
without any more bother.
</p>
<p>
To make the configuration easy the scgi_ctrl (and later, the scgi_cluster)
command will configure things for you with all options set to reasonable
defaults. What this command does is write a *config/scgi.yaml* file with
all the options you need.
</p>
<pre>
 &gt; cd myrailsapp
 &gt; scgi_ctrl config
 What password do you want? mypassiscool
</pre>
<p>
This configures your <a href="../classes/SCGI.html">SCGI</a> setup to have
the password &quot;mypassiscool&quot; which you&#8217;ll use later when you
control your rails deployment.
</p>
<p>
Once you&#8217;ve configured SRR you can start your first SRR by simply
doing:
</p>
<pre>
 &gt; scgi_ctrl start
</pre>
<p>
If you want to get more advanced you can simply run:
</p>
<pre>
 &gt; scgi_ctrl help config
</pre>
<p>
This will give you all of the possible options available.
</p>
<h2>The scgi.yaml Contents</h2>
<p>
You don&#8217;t <b>really</b> need to know this, but it might help in
debugging situations. For example, if your site seems to be a lot slower
than it should be then check the config/scgi.yaml file to see if :throttle:
is set.
</p>
<p>
The scgi.yaml file contains a YAML dump of an option map with these
settings:
</p>
<ul>
<li>:control_url: &#8212; The DRb URL used to control your deployment. (same
host with port == <a href="../classes/SCGI.html">SCGI</a>-1000, so
druby://127.0.0.1:8999)

</li>
<li>:env: &#8212; Environment setting for RAILS_ENV. (production)

</li>
<li>:host: &#8212; Host to bind. (127.0.0.1, other might be <b>bad</b> for
security)

</li>
<li>:password: &#8212; A crypt image of your password.

</li>
<li>:port: &#8212; Port to bind <a href="../classes/SCGI.html">SCGI</a> to.
(9999)

</li>
<li>:config: &#8212; The config file. Kind of redundant, but used by the
control tools. (config/scgi.yaml)

</li>
<li>:throttle: Optional connections/second throttle setting. (unlimited)

</li>
<li>:logfile: Logfile to write log messages. (log/scgi.log)

</li>
<li>:maxconns: &#8212; Optional maximum simultaneous connections before a user
is redirected to /busy.html

</li>
<li>:disable_signals &#8212; Turns off POSIX signal control (useful on Win32)

</li>
<li>:disable_drb &#8212; Turns off DRb control, which means no spiffy scgi_ctrl
or scgi_cluster.

</li>
</ul>
<p>
The :maxconns: and :throttle: options will only be in the file if you set
them. A very nice thing about SRR is that you can set these, then
reconfigure the processors and they&#8217;ll pick up the new values without
restarting. This is very handy if you have a nasty processor which is
eating your computer.
</p>
<h1>Running (UNIX)</h1>
<p>
Once you&#8217;ve configured SRR you can run it by just doing:
</p>
<pre>
 &gt; scgi_ctrl start
</pre>
<p>
Which of course starts it up on the two ports you configured. By default
this is 9999 for <a href="../classes/SCGI.html">SCGI</a> and 8999 for DRb.
</p>
<p>
All <a href="../classes/SCGI.html">SCGI</a> related activity (including any
weird errors) will show up in logs/scgi.log. You should look at this to see
if you get a line like:
</p>
<pre>
 [INF][15978] Running in production mode on 127.0.0.1:9999
</pre>
<p>
Which simply means an INFo message from PID 15978 that it&#8217;s listening
on port 9999 in production mode.
</p>
<h1>Running (Win32)</h1>
<p>
I haven&#8217;t completely tested this all on Win32 yet. There are two main
things about running under Win32. First that you <b>must</b> use the -S
option to scgi_ctrl config. This turns off POSIX signals since Win32
doesn&#8217;t support them. Second that you run the scgi_service script
manually with:
</p>
<pre>
 &gt; scgi_service
</pre>
<p>
This is simply because Ruby has really really really really bad support for
starting and stopping processes under Windows. I&#8217;m currently looking
at ways to either get Apache to start the scgi_service script dynamically
or to create a service that will do it.
</p>
<h1>Control</h1>
<p>
The control mechanism for SRR is a DRb based set of simple APIs you can
call. DRb is basically a Remote Procedure Call system for Ruby that&#8217;s
dead easy to use. The problem with DRb is that it has lousy security (which
I cover in the Security section below).
</p>
<p>
Before going into the normal mode of control, you should know that you can
also use POSIX signals to do just about everything:
</p>
<ul>
<li>TERM &#8212; Forced shutdown.

</li>
<li>INT &#8212; Graceful shutdown.

</li>
<li>HUP &#8212; Graceful restart (no forced).

</li>
<li>USR1 &#8212; Soft reconfigure (reloads config file).

</li>
<li>USR2 &#8212; Dumps status info to the logs. Super ugly.

</li>
</ul>
<p>
Refer to the scgi_ctrl help for more accurate information, but the commands
are:
</p>
<ul>
<li>config &#8212; Configure the <a href="../classes/SCGI.html">SCGI</a>
server. This you&#8217;ve already seen and it just generates a new
config/scgi.yaml file. You can actually do this while SRR is running and
then use reconfig to reload some options.

</li>
<li>monitor &#8212; Monitor the application. This just dumps status all the
time.

</li>
<li>reconfig &#8212; Reconfigure the <a href="../classes/SCGI.html">SCGI</a>
servers with a new config. This doesn&#8217;t load all options, but it will
reset :maxconns: and :throttle:.

</li>
<li>restart &#8212; Restart the application. This is a graceful shutdown
followed by a new exec of the same script.

</li>
<li>start &#8212; Start the application. Simply execs the scgi_service script
with the right config/scgi.yaml file.

</li>
<li>status &#8212; Get status. Prints out a status from the SRR service.

</li>
<li>stop &#8212; Stop the application. Does a graceful shutdown (can be
forced).

</li>
</ul>
<p>
The commands are pretty self explanatory (I hope). When you run a command
it will read the DRb :control_url: setting out of the config/scgi.yaml file
and try to connect to that URL. You can override this with the -u parameter
before the command like this:
</p>
<pre>
 &gt; scgi_ctrl -u druby://someotherhost.com:17000 status
</pre>
<p>
The other thing you&#8217;ll notice is that it asks you for a password.
This is the password that you configured earlier so you should remember it.
You can of course just use signals to shutdown if you forget.
</p>
<h1>Clusters</h1>
<p>
The new SRR comes with a fairly complete &quot;cluster&quot; management
command called <b>scgi_cluster</b>. It&#8217;s basically the exact same as
<b>scgi_ctrl</b> except it configures and works on any number of processors
at once. With <b>scgi_cluster</b> you can quickly configure a number of SRR
processors and manage them.
</p>
<h2>Cluster Configuration</h2>
<p>
Configuring is the same, except that there&#8217;s a new -c parameter to
configure the number of children you want to manage. What this does is
takes your initial parameters as the base, and then extends them for each
child.
</p>
<p>
For example, if you wanted 5 children all starting at port 9999 (DRb ort
8999) then you&#8217;d just use the defaults:
</p>
<pre>
  &gt; scgi_cluster config -c 5
</pre>
<p>
This will write out 5 config files&#8212;one for each processor. The ports
will start at 9999 and 8999 and increment by one from there. So you&#8217;d
have 9999, 10000, 10001, 10002, 10003.
</p>
<p>
The final difference is that scgi_cluster creates another
config/scgi-cluster.yaml file which tells it about your cluster.
</p>
<h2>Running a Cluster (UNIX)</h2>
<p>
Running your cluster is pretty much the same as with <b>scgi_ctrl</b> after
you&#8217;ve configured things.
</p>
<pre>
 &gt; scgi_cluster start
</pre>
<p>
This will start up your configured children and create a
config/scgi-children.yaml file for tracking the processes that get started.
You should also see log messages in log/scgi.log like this:
</p>
<pre>
 [INF][16129] Running in production mode on 127.0.0.1:9999
 [INF][16131] Running in production mode on 127.0.0.1:10001
 [INF][16130] Running in production mode on 127.0.0.1:10000
</pre>
<p>
Which are the same but one for each processor.
</p>
<h2>Running a Cluster (WINDOWS)</h2>
<p>
Running under Win32 does not work since Process.fork does not work.
Hopefully I can crack this nut soon.
</p>
<h2>Configuring Lighttpd Clusters</h2>
<p>
I figured I&#8217;d toss in the configuration I used for Lighttpd to get a
cluster going:
</p>
<pre>
 server.error-handler-404 = &quot;/dispatch.scgi&quot;
 scgi.server = ( &quot;dispatch.scgi&quot; =&gt;
        (
        &quot;server1&quot; =&gt;
                ( &quot;host&quot; =&gt; &quot;127.0.0.1&quot;,
                &quot;port&quot; =&gt; 9999,
                &quot;check-local&quot; =&gt; &quot;disable&quot;),

        &quot;server2&quot; =&gt;
                ( &quot;host&quot; =&gt; &quot;127.0.0.1&quot;,
                &quot;port&quot; =&gt; 10000,
               &quot;check-local&quot; =&gt; &quot;disable&quot;),

        &quot;server3&quot; =&gt;
                ( &quot;host&quot; =&gt; &quot;127.0.0.1&quot;,
                &quot;port&quot; =&gt; 10001,
               &quot;check-local&quot; =&gt; &quot;disable&quot;)
        )
 )
</pre>
<p>
That&#8217;s for three processors. It works pretty well although lighttpd
seems to favor the first processor rather than do a fair load balancing.
</p>
<h2>Cluster Control</h2>
<p>
Controlling the cluster is exactly the same except that <b>scgi_cluster</b>
runs against all the children listed in config/scgi-children.yaml and makes
them do things for you. All of the commands are the same, except the status
and monitor commands. Since there&#8217;s so many children running the
verbose status just doesn&#8217;t work. Instead, you can request verbose,
but you get an abbreviated status by default that looks like this:
</p>
<pre>
 16131   0/12    0       NA      false   1.88
 16129   0/12    0       NA      false   1.96
 16130   0/12    0       NA      false   1.88
</pre>
<p>
This is the PID, current connections/max connections, total requests
served, throttle setting, whether the process is in shutdown, and the total
user+sys time used.
</p>
<p>
It will also turn some of the display items red if they are out of control.
</p>
<h1>Security</h1>
<p>
Alright, listen up. I&#8217;m not gonna have people trying to take me to
court because they think I didn&#8217;t tell them about security problems.
Here are the main attack vectors you should be aware of when running this:
</p>
<ul>
<li>POSIX signals are bad if you&#8217;re in a shared hosting setup that
configures all processes to run as a common user like <b>nobody</b>. If
your provider does this then you should give <b>scgi_ctrl</b> the -S option
to turn them off.

</li>
<li>DRb is not <b>encrypted</b>. I repeat, DRB is <b>not</b> encrypted. This is
fine if you&#8217;re on a controlled machine and do everything on localhost
since if anyone breaks into your machine you have a lot more to worry about
than DRb leaking passwords. But, again, if you&#8217;re on a shared hosting
system then there&#8217;s a good chance someone can packet sniff the
localhost device and read your password. I&#8217;m looking at an SSL
configuration option for DRb in the near future.

</li>
<li>The config files under POSIX systems are created with your default umode
settings. No changes are made since most of the permission mode stuff
doesn&#8217;t work on Win32. Also, you should configure your umode when
you&#8217;re on shared hosting so that nobody else can read your files
anyway. This means that if you&#8217;re not careful someone can potentially
read or alter your configuration and make your program do bad things.

</li>
<li>I tried to remove all possible DRb methods except the allowed ones (DRb by
default only has blacklist access exclusion), but it might be possible for
someone to access the DRb port and find a way to run something remotely.
The password will really only protect against people from running the
control methods.

</li>
</ul>
<p>
That&#8217;s the gist of the security situation. Feel free to send me more
security warnings and if you have ideas to fix these problems then please
let me know.
</p>
<p>
Incidentally, don&#8217;t think that because I mention these here that
FastCGI doesn&#8217;t have these same problems. If you&#8217;re running
FastCGI processes in a shared hosting environment then you should check for
these same problems.
</p>

    </div>


   </div>


  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>